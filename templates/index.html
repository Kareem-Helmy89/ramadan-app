<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ØªØ·Ø¨ÙŠÙ‚ ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø´Ø®ØµÙŠØ§Øª - Ø±Ù…Ø¶Ø§Ù†</title>
    
    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='favicon.ico') }}">
    <link rel="shortcut icon" type="image/x-icon" href="{{ url_for('static', filename='favicon.ico') }}">
    
    <!-- Google Fonts - Arabic Ruq'ah Style (Optimized) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Aref+Ruqaa:wght@400;700&family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet" media="print" onload="this.media='all'">
    <noscript><link href="https://fonts.googleapis.com/css2?family=Aref+Ruqaa:wght@400;700&family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet"></noscript>
    
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="lanterns-pattern-top" style="background-image: url('{{ url_for('static', filename='favicon.ico') }}');"></div>
        <div class="container">
            <h1 class="header-title">Ø±Ù…Ø¶Ø§Ù† ÙƒØ±ÙŠÙ…</h1>
            <p class="header-subtitle">Ø¬Ø§Ù‡Ø² Ù„ØªØ¹Ø¨Ø¦Ø© Ø§Ù„ÙƒØ±Ø´ØŸ</p>
            <button class="iftar-times-btn" onclick="showIftarTimes()">
                ğŸ• Ù…ÙˆØ§Ø¹ÙŠØ¯ ØªØ¹Ø¨Ø¦Ø© Ø§Ù„ÙƒØ±Ø´
            </button>
        </div>
    </header>

    <!-- Iftar Times Modal -->
    <div id="iftarModal" class="iftar-modal">
        <div class="iftar-modal-content">
            <div class="iftar-modal-header">
                <h2>ğŸ• Ù…ÙˆØ§Ø¹ÙŠØ¯ ØªØ¹Ø¨Ø¦Ø© Ø§Ù„ÙƒØ±Ø´ (Ø£Ø°Ø§Ù† Ø§Ù„Ù…ØºØ±Ø¨)</h2>
                <button class="close-modal" onclick="closeIftarModal()">&times;</button>
            </div>
            <div class="iftar-modal-body">
                <div id="iftarLoading" class="iftar-loading">
                    <div class="loading-spinner-iftar"></div>
                    <p>Ø¬Ø§Ø±Ù ØªØ­Ù…ÙŠÙ„ Ù…ÙˆØ§Ø¹ÙŠØ¯ Ø£Ø°Ø§Ù† Ø§Ù„Ù…ØºØ±Ø¨...</p>
                    <p style="font-size: 0.9rem; color: var(--color-toffee-brown); margin-top: 10px;">Ù‚Ø¯ ÙŠØ³ØªØºØ±Ù‚ Ù‡Ø°Ø§ Ø¨Ø¶Ø¹ Ø«ÙˆØ§Ù†Ù</p>
                </div>
                <div id="iftarContent" class="iftar-content"></div>
            </div>
        </div>
    </div>

    <!-- Hero Section -->
    <main class="hero-section">
        <div class="container">
            <div class="character-display">
                <!-- Original Character -->
                <div class="character-card">
                    <h2 class="card-title">Ø§Ù„Ø´Ø®ØµÙŠØ© Ø§Ù„Ø£ØµÙ„ÙŠØ©</h2>
                    <div class="image-wrapper">
                        <img src="{{ url_for('static', filename='images/original-character.jpg') }}" 
                             alt="Ø§Ù„Ø´Ø®ØµÙŠØ© Ø§Ù„Ø£ØµÙ„ÙŠØ©" 
                             id="originalCharacter"
                             class="character-image"
                             loading="lazy"
                             decoding="async"
                             oncontextmenu="return false;"
                             draggable="false"
                             onselectstart="return false;">
                        <button class="download-btn" onclick="downloadImage('originalCharacter', 'original-character.jpg')" title="ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø©">
                            <span>â¬‡</span>
                        </button>
                    </div>
                </div>

                <!-- Selection Section -->
                <div class="input-card">
                    <h2 class="card-title">Ø§Ø®ØªØ± Ù†ÙˆØ¹ Ø§Ù„Ø´Ø®ØµÙŠØ©</h2>
                    
                    <div class="select-group">
                        <label for="categorySelect" class="select-label">Ø§Ù„ÙØ¦Ø©</label>
                        <select id="categorySelect" class="select-input" onchange="window.handleCategoryChange && window.handleCategoryChange(this.value)">
                            <option value="" selected disabled>Ø§Ø®ØªØ± ÙØ¦Ø©...</option>
                            <option value="arabCharacters">Ø´Ø®ØµÙŠØ§Øª Ø¹Ø±Ø¨ÙŠØ©</option>
                            <option value="foreignCharacters">Ø´Ø®ØµÙŠØ§Øª Ø£Ø¬Ù†Ø¨ÙŠØ©</option>
                            <option value="jobs">ÙˆØ¸Ø§Ø¦Ù ÙˆÙ…Ù‡Ù†</option>
                            <option value="clubs">Ø£Ù†Ø¯ÙŠØ© ÙƒØ±Ø© Ù‚Ø¯Ù…</option>
                        </select>
                    </div>

                    <div class="select-group">
                        <label for="itemSelect" class="select-label">Ø§Ù„ØªØµÙ…ÙŠÙ…</label>
                        <select id="itemSelect" class="select-input" disabled>
                            <option value="">Ø§Ø®ØªØ± Ø£ÙˆÙ„Ø§Ù‹ Ø§Ù„ÙØ¦Ø© Ù…Ù† Ø§Ù„Ø£Ø¹Ù„Ù‰</option>
                        </select>
                    </div>

                    <button id="showCharacterBtn" class="generate-btn">
                        <span class="btn-text">Ø¹Ø±Ø¶ Ø§Ù„Ø´Ø®ØµÙŠØ©</span>
                    </button>
                </div>

                <!-- Generated Result -->
                <div class="character-card">
                    <h2 class="card-title">Ø§Ù„Ø´Ø®ØµÙŠØ© Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©</h2>
                    <div class="image-wrapper">
                        <div id="resultPlaceholder" class="result-placeholder">
                            <p>Ø§Ø®ØªØ± ÙØ¦Ø© ÙˆØªØµÙ…ÙŠÙ… Ù…Ù† Ø§Ù„ÙˆØ³Ø· Ù„Ø¹Ø±Ø¶ Ø§Ù„ØµÙˆØ±Ø© Ù‡Ù†Ø§</p>
                        </div>
                        <img id="generatedImage" 
                             src="" 
                             alt="Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ù…ÙˆÙ„Ø¯Ø©" 
                             class="character-image"
                             style="display: none;"
                             oncontextmenu="return false;"
                             draggable="false"
                             onselectstart="return false;">
                        <button class="download-btn" id="downloadGeneratedBtn" onclick="downloadImage('generatedImage', 'generated-character.jpg')" title="ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø©" style="display: none;">
                            <span>â¬‡</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Gallery Section -->
    <section class="gallery-section">
        <div class="container">
            <div id="galleryGrid" class="gallery-grid">
                {% if recent_generations %}
                    {% for generation in recent_generations %}
                    <div class="gallery-item">
                        <div class="gallery-image-wrapper">
                            <img src="{{ generation.image_url }}" 
                                 alt="{{ generation.prompt }}" 
                                 class="gallery-image"
                                 loading="lazy"
                                 decoding="async"
                                 oncontextmenu="return false;"
                                 draggable="false"
                                 onselectstart="return false;"
                                 onerror="this.src='{{ url_for('static', filename='images/placeholder.jpg') }}'">
                            <button class="download-btn" onclick="downloadImageFromUrl('{{ generation.image_url }}', 'gallery-image-{{ generation.id }}.jpg')" title="ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø©">
                                <span>â¬‡</span>
                            </button>
                        </div>
                        <p class="gallery-prompt">{{ generation.prompt }}</p>
                        <span class="gallery-date">{{ generation.created_at.strftime('%Y-%m-%d %H:%M') if generation.created_at else '' }}</span>
                    </div>
                    {% endfor %}
                {% else %}
                    <div class="empty-gallery">
                        <div class="philosophical-quote">
                            <p class="quote-line">ØªÙ… ØªØ¹Ø¨Ø¦Ø© Ø§Ù„ÙƒØ±Ø´ Ø¨Ù†Ø¬Ø§Ø­ØŒ ÙˆÙ„ÙƒÙ† ...</p>
                            <p class="quote-text">ÙˆÙ„ÙƒÙ† Ù…Ù† Ø°Ø§ Ø§Ù„Ø°ÙŠ ÙŠØ¹Ø¨Ø¦ Ø§Ù„ÙØ±Ø§Øº Ø§Ù„ÙƒØ§Ù…Ù† ÙÙŠ Ø£Ø¹Ù…Ø§Ù‚ Ù‚Ù„ÙˆØ¨Ù†Ø§ØŸ</p>
                            <p class="quote-text">Ø£Ù‡Ùˆ Ø§Ù„Ø²Ù…Ù†ØŸ Ø£Ù… Ø§Ù„Ø¢Ø®Ø±ÙˆÙ†ØŸ</p>
                            <p class="quote-text">Ø£Ù… Ù†Ø­Ù† Ø£Ù†ÙØ³Ù†Ø§ ÙÙŠ ØµØ±Ø§Ø¹Ù†Ø§ Ø§Ù„Ø¯Ø§Ø¦Ù… Ù…Ø¹ Ø§Ù„Ø¹Ø¯Ù…ØŸ</p>
                            <p class="quote-text">ÙˆØ¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø§Ù…ØªÙ„Ø§Ø¡ Ù…Ù…ÙƒÙ†Ø§Ù‹ØŒ ÙØ¨Ø£ÙŠ Ø¬ÙˆÙ‡Ø± ÙŠÙØµØ§ØºØŸ</p>
                            <p class="quote-text">Ø£Ù‡Ùˆ Ø§Ù„Ø­Ø¨ØŸ Ø£Ù… Ø§Ù„Ù…Ø¹Ø±ÙØ©ØŸ</p>
                            <p class="quote-text">Ø£Ù… Ù…Ø¬Ø±Ø¯ ÙˆÙ‡Ù… Ø¢Ø®Ø± ÙŠÙƒØ³Ùˆ Ø®ÙˆØ§Ø¡ Ø¬Ø¯ÙŠØ¯Ø§Ù‹ Ø¨Ø«ÙˆØ¨ Ù…Ø®ØªÙ„ÙØŸ!</p>
                        </div>
                    </div>
                {% endif %}
            </div>
        </div>
    </section>

    <!-- Footer -->
    <footer class="footer">
        <div class="container">
            <div class="footer-attribution">
                Icons made by <a href="https://www.freepik.com" title="Freepik" target="_blank" rel="noopener noreferrer">Freepik</a> from <a href="https://www.flaticon.com/" title="Flaticon" target="_blank" rel="noopener noreferrer">www.flaticon.com</a>
            </div>
        </div>
    </footer>

    <!-- Defer JavaScript loading for faster page load -->
    <script src="{{ url_for('static', filename='js/main.js') }}?v=3.0" defer></script>
    
    <!-- Image Download and Protection Functions -->
    <script>
        // Prevent right-click, drag, and copy
        document.addEventListener('contextmenu', function(e) {
            if (e.target.tagName === 'IMG' && e.target.classList.contains('character-image') || e.target.classList.contains('gallery-image')) {
                e.preventDefault();
                return false;
            }
        });

        document.addEventListener('dragstart', function(e) {
            if (e.target.tagName === 'IMG' && (e.target.classList.contains('character-image') || e.target.classList.contains('gallery-image'))) {
                e.preventDefault();
                return false;
            }
        });

        document.addEventListener('selectstart', function(e) {
            if (e.target.tagName === 'IMG' && (e.target.classList.contains('character-image') || e.target.classList.contains('gallery-image'))) {
                e.preventDefault();
                return false;
            }
        });

        // Disable keyboard shortcuts for copy
        document.addEventListener('keydown', function(e) {
            if ((e.ctrlKey || e.metaKey) && (e.key === 'c' || e.key === 'C' || e.key === 'x' || e.key === 'X')) {
                const target = e.target;
                if (target.tagName === 'IMG' && (target.classList.contains('character-image') || target.classList.contains('gallery-image'))) {
                    e.preventDefault();
                    return false;
                }
            }
        });

        // Download image function
        function downloadImage(imageId, filename) {
            const img = document.getElementById(imageId);
            if (!img || !img.src || img.style.display === 'none') {
                return;
            }

            // Create a link element
            const link = document.createElement('a');
            link.href = img.src;
            link.download = filename;
            link.target = '_blank';
            
            // Trigger download
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // Download image from URL
        function downloadImageFromUrl(imageUrl, filename) {
            if (!imageUrl) {
                return;
            }

            // Fetch the image and convert to blob
            fetch(imageUrl)
                .then(response => response.blob())
                .then(blob => {
                    const url = window.URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = filename;
                    link.target = '_blank';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    window.URL.revokeObjectURL(url);
                })
                .catch(error => {
                    console.error('Error downloading image:', error);
                    // Fallback: open in new tab
                    window.open(imageUrl, '_blank');
                });
        }

        // Iftar Times Functions
        function showIftarTimes() {
            const modal = document.getElementById('iftarModal');
            const loading = document.getElementById('iftarLoading');
            const content = document.getElementById('iftarContent');
            
            modal.style.display = 'block';
            loading.style.display = 'block';
            content.style.display = 'none';
            content.innerHTML = '';
            
            // Fetch iftar times
            fetch('/api/iftar-times')
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('Data received:', data);
                    console.log('Countries:', Object.keys(data.countries || {}));
                    console.log('Dates:', data.dates);
                    loading.style.display = 'none';
                    if (data.success && data.countries && data.dates && data.dates.length > 0) {
                        // Check if we have any times
                        const hasTimes = Object.values(data.countries).some(country => 
                            country.times && Object.values(country.times).some(time => time !== '--:--')
                        );
                        if (hasTimes) {
                            displayIftarTimes(data);
                        } else {
                            content.innerHTML = '<p style="text-align: center; color: red; padding: 20px;">Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù…ÙˆØ§Ø¹ÙŠØ¯. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰ Ø£Ùˆ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª.</p>';
                            content.style.display = 'block';
                        }
                    } else {
                        content.innerHTML = '<p style="text-align: center; color: red; padding: 20px;">Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…ÙˆØ§Ø¹ÙŠØ¯: ' + (data.error || 'Ø®Ø·Ø£ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ') + '</p>';
                        content.style.display = 'block';
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    loading.style.display = 'none';
                    content.innerHTML = '<p style="text-align: center; color: red; padding: 20px;">Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…ÙˆØ§Ø¹ÙŠØ¯: ' + error.message + '<br>ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.</p>';
                    content.style.display = 'block';
                });
        }

        function closeIftarModal() {
            document.getElementById('iftarModal').style.display = 'none';
        }

        function displayIftarTimes(data) {
            const content = document.getElementById('iftarContent');
            const today = new Date().toISOString().split('T')[0];
            
            console.log('Displaying times for dates:', data.dates);
            console.log('Countries:', Object.keys(data.countries));
            
            if (!data.dates || data.dates.length === 0) {
                content.innerHTML = '<p style="text-align: center; color: red; padding: 20px;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…ÙˆØ§Ø¹ÙŠØ¯ Ù…ØªØ§Ø­Ø©.</p>';
                content.style.display = 'block';
                return;
            }
            
            // Create table
            let html = '<div class="iftar-table-wrapper"><table class="iftar-table"><thead><tr><th>Ø§Ù„Ø¨Ù„Ø¯</th>';
            
            // Add date headers
            data.dates.forEach(date => {
                const dateObj = new Date(date + 'T00:00:00');
                const dayName = dateObj.toLocaleDateString('ar-EG', { weekday: 'short' });
                const dayNum = dateObj.getDate();
                const monthName = dateObj.toLocaleDateString('ar-EG', { month: 'short' });
                const isToday = date === today;
                html += `<th ${isToday ? 'class="today-cell"' : ''}>${dayName}<br>${dayNum} ${monthName}</th>`;
            });
            
            html += '</tr></thead><tbody>';
            
            // Add country rows
            const countries = Object.keys(data.countries);
            if (countries.length === 0) {
                html += '<tr><td colspan="' + (data.dates.length + 1) + '" style="text-align: center; padding: 20px;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù…ØªØ§Ø­Ø©</td></tr>';
            } else {
                countries.forEach(country => {
                    html += `<tr><td class="country-name">${country}</td>`;
                    data.dates.forEach(date => {
                        const countryData = data.countries[country];
                        const time = (countryData && countryData.times && countryData.times[date]) ? countryData.times[date] : '--:--';
                        const isToday = date === today;
                        html += `<td ${isToday ? 'class="today-cell"' : ''}>${time}</td>`;
                    });
                    html += '</tr>';
                });
            }
            
            html += '</tbody></table></div>';
            content.innerHTML = html;
            content.style.display = 'block';
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('iftarModal');
            if (event.target === modal) {
                closeIftarModal();
            }
        }
    </script>
    
    <!-- Redirect to loading page only if video not shown before -->
    <script>
        // Check if video was already shown (once per browser)
        const hasSeenVideo = localStorage.getItem('hasSeenLoadingVideo');
        if (!hasSeenVideo) {
            // First time - show loading video
            window.location.replace('{{ url_for("loading") }}');
        }
        // If already shown, stay on this page
    </script>
</body>
</html>
